@page "/purchasing"
@using System.Globalization
@using MDAS.Components.Layout
@layout AdminLayout

<PageTitle>Midas - Purchasing</PageTitle>

<div class="container-fluid p-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold" style="color: #020412;">
                @if (activeView == "main")
                {
                    <text>Purchasing & Orders</text>
                }
                else if (activeView == "suppliers")
                {

                    <text>Supplier Database</text>
                }
                else if (activeView == "receiving")
                {

                    <text>Receiving Dock</text>
                }
            </h2>
            <p class="text-muted">
                @if (activeView == "main")
                {
                    <text>Create Purchase Orders (Money Out)</text>
                }
                else if (activeView == "suppliers")
                {

                    <text>Manage vendor contact details</text>
                }
                else if (activeView == "receiving")
                {

                    <text>Process incoming shipments</text>
                }
            </p>
        </div>

        <div class="d-flex gap-2 bg-white p-1 rounded-pill border shadow-sm">
            <button class="btn rounded-pill px-3 @(activeView == "main" ? "btn-navy" : "btn-light text-muted")"
                    @onclick='() => activeView = "main"'>
                <i class="bi bi-file-earmark-text me-2"></i>Orders
            </button>
            <button class="btn rounded-pill px-3 @(activeView == "suppliers" ? "btn-navy" : "btn-light text-muted")"
                    @onclick='() => activeView = "suppliers"'>
                <i class="bi bi-truck me-2"></i>Suppliers
            </button>
            <button class="btn rounded-pill px-3 @(activeView == "receiving" ? "btn-navy" : "btn-light text-muted")"
                    @onclick='() => activeView = "receiving"'>
                <i class="bi bi-box-seam me-2"></i>Receiving
            </button>
        </div>
    </div>

    @if (activeView == "main")
    {
        <div class="row g-4">
            <div class="col-lg-9">
                <div class="card border-0 shadow-sm rounded-4 mb-4">
                    <div class="card-body p-4">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label small text-muted fw-bold">SELECT SUPPLIER</label>
                                <select class="form-select rounded-3 border-secondary-subtle">
                                    <option selected>Select a Supplier...</option>
                                    @foreach (var s in SuppliersList)
                                    {
                                        <option>@s.CompanyName</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small text-muted fw-bold">PO NUMBER</label>
                                <input type="text" class="form-control rounded-3" value="PO-2025-0089" readonly style="background-color: #f8f9fa;" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small text-muted fw-bold">EXPECTED DATE</label>
                                <input type="date" class="form-control rounded-3" />
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small text-muted fw-bold">STATUS</label>
                                <span class="badge bg-warning text-dark d-block p-2 rounded-3">Draft</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4 mb-4" style="border-left: 5px solid #020412 !important;">
                    <div class="card-header bg-white border-bottom-0 pt-4 pb-0">
                        <h5 class="fw-bold text-navy"><i class="bi bi-plus-circle-fill me-2"></i>Add Item to Order</h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="row align-items-end g-3">
                            <div class="col-md-4">
                                <label class="form-label small text-muted fw-bold">PRODUCT SEARCH</label>
                                <input class="form-control" list="productOptions" placeholder="Type 'Red Dress'..." @bind="tempProductName" @oninput="OnProductInput" />
                                <datalist id="productOptions">
                                    @foreach (var p in MockProductDb)
                                    {
                                        <option value="@p.Name">@p.SKU</option>
                                    }
                                </datalist>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small text-muted fw-bold">SIZE / COLOR</label>
                                <select class="form-select" @bind="tempVariant">
                                    <option value="" disabled selected>Select...</option>
                                    @foreach (var v in currentAvailableVariants)
                                    {
                                        <option value="@v">@v</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small text-muted fw-bold">QUANTITY</label>
                                <input type="number" class="form-control" min="1" @bind="tempQty" />
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small text-muted fw-bold">COST (₱)</label>
                                <input type="number" class="form-control" step="0.01" @bind="tempCost" />
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-navy w-100 py-2 fw-bold" @onclick="AddToGrid">+ ADD</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4">
                    <div class="card-body p-0">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light text-secondary small text-uppercase">
                                <tr>
                                    <th class="ps-4 py-3">Product Name</th>
                                    <th>Variant</th>
                                    <th class="text-center">Qty</th>
                                    <th class="text-end">Unit Cost</th>
                                    <th class="text-end">Total</th>
                                    <th class="text-center pe-4">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (OrderItems.Count == 0)
                                {
                                    <tr>
                                        <td colspan="6" class="text-center py-5 text-muted">
                                            <i class="bi bi-basket display-6 d-block mb-3 opacity-25"></i>
                                            No items added yet.
                                        </td>
                                    </tr>
                                }
                                else
                                {
                                    @foreach (var item in OrderItems)
                                    {
                                        <tr>
                                            <td class="ps-4 fw-bold text-navy">@item.ProductName</td>
                                            <td><span class="badge bg-light text-dark border">@item.Variant</span></td>
                                            <td class="text-center">@item.Qty</td>
                                            <td class="text-end">@item.UnitCost.ToString("N2")</td>
                                            <td class="text-end fw-bold">@((item.Qty * item.UnitCost).ToString("N2"))</td>
                                            <td class="text-center pe-4">
                                                <button class="btn btn-sm btn-outline-danger border-0" @onclick="() => RemoveItem(item)">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-lg-3">
                <div class="card border-0 shadow-sm rounded-4 position-sticky" style="top: 20px;">
                    <div class="card-body p-4">
                        <h5 class="fw-bold mb-4">Order Summary</h5>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Subtotal</span>
                            <span class="fw-bold">₱ @OrderItems.Sum(i => i.Qty * i.UnitCost).ToString("N2")</span>
                        </div>
                        <div class="border-top pt-3 mb-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-bold text-navy h5 mb-0">Total</span>
                                <span class="fw-bold text-navy h4 mb-0">₱ @OrderItems.Sum(i => i.Qty * i.UnitCost).ToString("N2")</span>
                            </div>
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-navy py-2 rounded-pill shadow-sm"><i class="bi bi-check-lg me-2"></i>Create Order</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    @if (activeView == "suppliers")
    {
        <div class="card border-0 shadow-sm rounded-4">
            <div class="card-header bg-white border-bottom-0 py-3 d-flex justify-content-between align-items-center">
                <h6 class="fw-bold text-navy mb-0">Registered Vendors</h6>
                <button class="btn btn-sm btn-navy rounded-pill"><i class="bi bi-plus-lg me-1"></i> New</button>
            </div>
            <div class="card-body p-0">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light text-secondary small text-uppercase">
                        <tr>
                            <th class="ps-4 py-3">Company Name</th>
                            <th>Contact Person</th>
                            <th>Email / Phone</th>
                            <th>Category</th>
                            <th>Status</th>
                            <th class="text-end pe-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var s in SuppliersList)
                        {
                            <tr>
                                <td class="ps-4 fw-bold text-navy">@s.CompanyName</td>
                                <td>@s.ContactPerson</td>
                                <td>
                                    <div class="small text-dark">@s.Email</div>
                                    <div class="small text-muted">@s.Phone</div>
                                </td>
                                <td><span class="badge bg-light text-dark border">@s.Category</span></td>
                                <td><span class="badge bg-success-subtle text-success rounded-pill px-3">Active</span></td>
                                <td class="text-end pe-4">
                                    <button class="btn btn-sm btn-light border me-1"><i class="bi bi-pencil"></i></button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }

    @if (activeView == "receiving")
    {
        <div class="card border-0 shadow-sm rounded-4">
            <div class="card-header bg-white border-bottom-0 py-3">
                <h6 class="fw-bold text-navy mb-0">Expected Shipments</h6>
            </div>
            <div class="card-body p-0">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light text-secondary small text-uppercase">
                        <tr>
                            <th class="ps-4 py-3">PO Number</th>
                            <th>Supplier</th>
                            <th>Expected Date</th>
                            <th>Total Items</th>
                            <th>Status</th>
                            <th class="text-end pe-4">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var po in IncomingOrders)
                        {
                            <tr>
                                <td class="ps-4 fw-bold text-navy">@po.PONumber</td>
                                <td>@po.Supplier</td>
                                <td>@po.Date.ToShortDateString()</td>
                                <td>@po.ItemCount units</td>
                                <td>
                                    @if (po.Status == "Partial")
                                    {
                                        <span class="badge bg-warning text-dark rounded-pill">Partial</span>
                                    }
                                    else
                                    {

                                        <span class="badge bg-info text-dark rounded-pill">Pending</span>
                                    }
                                </td>
                                <td class="text-end pe-4">
                                    <button class="btn btn-navy btn-sm rounded-pill px-3">
                                        <i class="bi bi-box-seam me-1"></i> Receive
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

@code {
    // STATE: "main", "suppliers", "receiving"
    private string activeView = "main";

    // --- ORDER MODELS & LOGIC ---
    public class OrderItem { public string ProductName { get; set; } = ""; public string Variant { get; set; } = ""; public int Qty { get; set; } public decimal UnitCost { get; set; } }
    public class ProductMock { public string Name { get; set; } = ""; public string SKU { get; set; } = ""; public decimal DefaultCost { get; set; } public List<string> Variants { get; set; } = new(); }

    private List<ProductMock> MockProductDb = new List<ProductMock> {
        new ProductMock { Name = "Red Summer Dress", SKU = "W-DRS-001", DefaultCost = 450.00m, Variants = new() { "Small", "Medium", "Large" } },
        new ProductMock { Name = "Denim Jacket", SKU = "M-JKT-002", DefaultCost = 850.00m, Variants = new() { "M", "L", "XL", "Black Denim" } },
        new ProductMock { Name = "Cotton T-Shirt", SKU = "U-TSH-003", DefaultCost = 150.00m, Variants = new() { "White S", "White M", "Black S", "Black M" } }
    };

    private string tempProductName = "";
    private string tempVariant = "";
    private int tempQty = 1;
    private decimal tempCost = 0;
    private List<string> currentAvailableVariants = new();
    private List<OrderItem> OrderItems = new();

    private void OnProductInput(ChangeEventArgs e)
    {
        string input = e.Value?.ToString() ?? "";
        tempProductName = input;
        var foundProduct = MockProductDb.FirstOrDefault(p => p.Name.Equals(input, StringComparison.OrdinalIgnoreCase));
        if (foundProduct != null) { tempCost = foundProduct.DefaultCost; currentAvailableVariants = foundProduct.Variants; tempVariant = ""; }
        else { currentAvailableVariants = new(); tempCost = 0; }
    }
    private void AddToGrid()
    {
        if (string.IsNullOrWhiteSpace(tempProductName) || tempQty <= 0) return;
        OrderItems.Add(new OrderItem { ProductName = tempProductName, Variant = string.IsNullOrEmpty(tempVariant) ? "Standard" : tempVariant, Qty = tempQty, UnitCost = tempCost });
        tempProductName = ""; tempVariant = ""; tempQty = 1; tempCost = 0; currentAvailableVariants = new();
    }
    private void RemoveItem(OrderItem item) { OrderItems.Remove(item); }

    // --- SUPPLIER DATA ---
    public class Supplier { public string CompanyName { get; set; } = ""; public string ContactPerson { get; set; } = ""; public string Email { get; set; } = ""; public string Phone { get; set; } = ""; public string Category { get; set; } = ""; }
    private List<Supplier> SuppliersList = new List<Supplier> {
        new Supplier { CompanyName = "Fabric World Inc.", ContactPerson = "Maria Santos", Email = "orders@fabricworld.ph", Phone = "0917-123-4567", Category = "Raw Materials" },
        new Supplier { CompanyName = "Global Garments Co.", ContactPerson = "John Lim", Email = "j.lim@globalgarments.com", Phone = "0998-987-6543", Category = "Finished Goods" },
        new Supplier { CompanyName = "Davao Textile Hub", ContactPerson = "Sarah Dut", Email = "info@davaotextile.com", Phone = "082-222-3333", Category = "Textiles" },
    };

    // --- RECEIVING DATA ---
    public class PurchaseOrder { public string PONumber { get; set; } = ""; public string Supplier { get; set; } = ""; public DateTime Date { get; set; } public int ItemCount { get; set; } public string Status { get; set; } = "Pending"; }
    private List<PurchaseOrder> IncomingOrders = new List<PurchaseOrder> {
        new PurchaseOrder { PONumber = "PO-2025-0088", Supplier = "Fabric World Inc.", Date = DateTime.Now.AddDays(2), ItemCount = 500, Status = "Pending" },
        new PurchaseOrder { PONumber = "PO-2025-0085", Supplier = "Davao Textile Hub", Date = DateTime.Now.AddDays(-1), ItemCount = 120, Status = "Partial" },
    };
}

<style>
    .text-navy {
        color: #020412;
    }

    .bg-navy {
        background-color: #020412;
        color: white;
        transition: all 0.2s;
    }

    .btn-navy:hover {
        background-color: #0c006b;
        color: white;
        transform: translateY(-1px);
    }
</style>